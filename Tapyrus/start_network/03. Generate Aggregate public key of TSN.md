# 03. Generate Aggregate public key of TSN

> TSN = Tapyrus Signer Network

　この章では各SignerがTSNの集約公開鍵とNSS(Node secret share)を取得する方法を説明します。

　TSNはブロックに対し署名を生成します。この署名は「各Signerの秘密鍵を集約した集約秘密鍵で署名したもの」と同じになります。そのため、TSNにより署名されたブロックは各Signerの公開鍵を集約した集約公開鍵で検証することができます。

　しかし、TNSの各Signerは署名の生成に集約秘密鍵を使用していません。TSNは分散schnorr署名方式を採用し、各Signerはノード秘密分散(NSS = Node secret chare)と呼ばれる秘密分散により署名を生成しています。

　つまり、集約秘密鍵ではなくNSSにより署名をしているが、署名の結果は集約秘密鍵で行ったそれと一致するため、集約公開鍵で検証することが可能となっています。



ここからは実際に集約公開鍵とNSSを生成する手順を説明します。

## 1. Generate key pair

まず、各Signerで `tapyrus-setup createkey` を用いて各自キーペアを生成します。

```bash
$ tapyrus-setup createkey
```

返答は以下です。

```
<private_key> <public_key>
```

これらのキーペアはsecp256k1楕円曲線に基づき生成されます。また、private_keyは拡張WIF形式、public_keyは16進数表示です。

次に、各Signerは生成された自身の公開鍵を他のSignerに共有し、受け取った公開鍵をソートします。

以下では、Signerは公開鍵でソートされ、Signer[i] (i=0,1..n) と表記します。

## 2. Generate node verifiable secret shares

次に、各Signerは `tapyrus-setup createnodevss` を用いてノードVSSを生成します。

```bash
$ tapyrus-setup createnodevss \
	--public-key=<public_key[1]> --public-key=<public_key[2]> ... --public-key=<public_key[n]> \
  	--private-key=<private_key[i]> \
  	--threshold=<t>
```

- `<public_key[j]>` は先ほど生成し共有された各Signerの公開鍵
- `<private_key[i]>` は自身の秘密鍵
- `<t>` はブロック署名に必要なSignerの最小数、つまり閾値

返答は以下です。

```
<public_key[1]>: <node_vss[i, 1]>,
<public_key[2]>: <node_vss[i, 2]>,
...
<public_key[n]>: <node_vss[i, n]]>
```

公開鍵と同様、Signerは生成したノードVSSを各Signerに共有します。

ここで、ノードVSSは共通鍵暗号化方式 ChaCha20-Poly1305で暗号化され、Base58でエンコードされているため、一般的には秘密鍵が知られていない限りはノードVSSから秘密値を知ることは不可能です。しかし、セキュリティの観点からは、ノードVSSであっても安全な通信チャネルを用いて他者に共有することが望まれます。

## 3. Generate an Aggregated public key

最後に、Signer[i]は他のSignerからノードVSSを受け取った後、公開鍵を集約しNSSを計算します。

```bash
$ tapyrus-setup aggregate \
  --vss=<node_vss[1, i]> --vss=<node_vss[2, i]> ... --vss=<node_vss[n, i]> \
  --private-key=<private_key[i]>
```

- `<node_vss[j, i]>` は各Signerから受け取ったノードVSS
- `<private_key[i]>` は自身の秘密鍵

返答は以下です。

```
<aggregated_public_key> <node_secret_share[i]>
```

出力の `<aggregated_public_key>` がTNSの集約公開鍵となり、これは各Signerとも同じ値を返します。`<node_secret_share>` はSigner[i] 固有のNSSであり、16進数で表示されます。

注意すべきは、NSSは暗号化されていないことです。これはNSSを他のSignerに送信することを想定していないからです。NSSは各Signerが安全に保管する必要があります。



以上で集約公開鍵と各SignerのNSSを生成することができました。